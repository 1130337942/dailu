$(function($){
//配置turn.json
           
            var day_list_img = [];
            var daylist=[];
            var trip = getUrlParam('trip');
            var u = getUrlParam('them');
            var this_uid = getCookie('uid');   
            var ewm_url = window.location.href.replace('books','tripinfoshare');
            ewm_url ='../store/getarcode?url='+ encodeURIComponent(ewm_url);
            var issue = false ;
            var travelHotelArr=[];
            var travelFoodArr=[];
            $('.phone_img .ewm,.hard_last .ewm').attr('src',ewm_url);
            if(u!=this_uid){
               $('.editTrip').hide();
            }
        $('.editTrip').on('click',function(oEvent){
            //省份下的城市
            sessionStorage.setItem("trip_id",trip);
            sessionStorage.setItem("isEdit",'ok');
            window.location.href="/portal/scenerymap/attractionsArrange.html";
        })
        

            $.post('BooksData',{'collect_uid':this_uid,'uid':u,'trip_id':trip},function(res){
                if(!res.Schedufing) return false ;

                if(res.gailan.old_new && res.gailan.old_new == 'new'){//判断是不是老单
                    $('.calendar.calendar_pat').remove()
                }else{
                    layer.msg('部分景点已经更新，袋鹿建议您重新规划行程',{
                        time:3000
                    },function(){
                        window.history.go(-1);
                    })
                    $('.calendar.new_calendar_pat').remove()
                    $('.calendar.calendar_pat').hide();
                    $('.book_box').show();
                }


                if(res.status!=0) {//未发布
                    $('.issue').addClass('disabled').removeClass('issue').text('已发布');
                    issue = true;
                }
                if(!res.hotel_money) res.hotel_money = [];
                $(res.gailan.go_city_array).each(function(i,ele){
                    switch(this.city_trc_name.trim())
                    {
                        case '铁路交通':
                        this.traffic_ico = 'train'
                        this.use_time = this.trainTime
                        break;
                        case '飞机交通':
                        this.traffic_ico = 'plane';
                        this.use_time = this.flightTime
                        break;
                        default:
                        this.traffic_ico  = 'bus'
                        this.use_time = this.trafficTime;
                    }
                    res.Schedufing[i].city_trc_name = this.city_trc_name;
                    res.Schedufing[i].traffic_ico = this.traffic_ico;
                    res.Schedufing[i].dis = this.dis;
                    res.Schedufing[i].use_time = this.use_time;
                })

                /*行程线路部分 start*/
                
                var lineTitle = res.gailan.departure_city+'/';
                var mainMaparr = [{lat:res.gailan.dep_lat,lng:res.gailan.dep_lng}];
                var gailan = '';
                var first_day  = 0;
                $(res.gailan.go_city_array).each(function(i,ele){
                    mainMaparr.push(this.position);
                    lineTitle += this.city_name+'/';
                    var city_daynum_arr = [];
                    for(var k=0;k<this.city_daynum;k++){
                        first_day ++
                        city_daynum_arr.push(first_day);
                    }
                    this.city_daynum_arr = city_daynum_arr;
                });
               
                lineTitle = lineTitle + res.gailan.return_city;
                $('.overview .header_line').text(lineTitle);
                $('.city_catalog_box .start_catalog span').text(res.gailan.departure_city)
                $('.city_catalog_box .start_catalog .day').text(res.gailan.date)
                $('.city_catalog_box .city_catalog_last span').text(res.gailan.return_city)
                $('.city_catalog_box .city_catalog_last .day').text(res.xianlu.return_date)
                var overviewRender = template.compile(overviewTemplate);
                var overview_str = overviewRender(res.gailan);
                    $('.city_catalog_last').before(overview_str);
                renderMap(mainMaparr,$('.main_map img'),true);

                /*行程链路部分 end*/


                /*行程概览 start*/
                var traffiCost  = res.traffic_money; 
                var trafficTot = 0;
                var traffic_table = '';
                var bus_num  = 0 ; 
                var plane_num = 0 ; 
                var train_num = 0 ; 
                $(traffiCost).each(function(i,ele) {
                    this.line_cros = this.start_city +'—'+this.city_name;
                    trafficTot += this.price*this.people;
                    switch(this.city_trc_name.trim())
                    {
                        case '铁路交通':
                        this.traffic_ico = 'train'
                        train_num++;
                        break;
                        case '飞机交通':
                        this.traffic_ico = 'plane'
                        plane_num++;
                        break;
                        default:
                        this.traffic_ico = 'bus'
                        bus_num ++ ;
                    }
                    traffic_table +='<div class="list">'+
                                   '    <span class="wap_1">'+
                                   '        <i class="wap_ico '+this.traffic_ico+'"></i>'+ this.line_cros+
                                   '    </span>'+
                                   '    <span class="wap_2">¥'+ this.price +'起</span>'+
                                   '    <span class="wap_3">x'+ this.people +'</span>'+
                                   '    <span class="wap_3">¥'+this.price*this.people +'起</span>'+
                            '</div>'
                });
                $('.wap_content_traffic').html(traffic_table);

                var p_str = plane_num>0?'飞机'+plane_num+'次，':'';
                var t_str = train_num>0?'铁路'+train_num+'次，':'';
                var b_str = bus_num>0?'其它交通'+bus_num+'次，':'';
                var  traffic_num =  p_str+t_str+b_str ;
                $('.overview').find('.person_num').text(res.gailan.adult+'成人，'+res.gailan.children+'儿童').end()
                .find('.day_num').text(res.gailan.day_num+'天').end()
                .find('.start_city').text(res.gailan.departure_city).end()
                .find('.last_city').text(res.gailan.return_city).end()
                .find('.start_date').text(res.gailan.date).end()
                .find('.hotel_num').text('共'+res.hotel_money.length).end()
                .find('.traffic_num').text(traffic_num.substring(0,traffic_num.length-1));
                /*行程概览 end*/

                /*right_bar start*/
                var right_bar_str = '';
                    for(var i= 0; i<res.gailan.day_num;i+=2){
                        var D2 = (i+2)>res.gailan.day_num?'':'/D'+(i+2);
                        right_bar_str += '<li index='+(6+i) +' class="bar dayindex">D'+ (i+1)+D2+'</li>'
                    }
                    $('.book_right_bar ul').append(right_bar_str);
                /*right_bar end*/

                /*费用清单 start*/
                    var ticket_tot = 0;
                    var ticket_table='';
                    var hotel_tot =0;
                    var hotel_table =''

                        $(res.hotel_money).each(function(i,ele){
                        hotel_tot += this.LowRate*this.number_night;
                        hotel_table += '<div class="list">'+
                                   '   <span class="wap_1">'+
                                   '        <i class="wap_ico hotel"></i>'+this.hotel_name+
                                   '    </span>'+
                                   '    <span class="wap_2">¥'+(this.LowRate*1).toFixed(1)+'起</span>'+
                                   '    <span class="wap_3">x'+this.number_night+'</span>'+
                                   '    <span class="wap_3">¥'+(this.number_night*this.LowRate).toFixed(1)+'起</span>'+
                            '</div>'
                        })
                        $('.wap_content_hotel').html(hotel_table);             
                                   
                    var eat_tot =0;
                    var eat_table =''

                        $(res.eat_money).each(function(i,ele){
                        eat_tot += this.price*this.people;
                        eat_table += '<div class="list">'+
                                   '   <span class="wap_1">'+
                                   '        <i class="wap_ico hotel"></i>'+this.name+
                                   '    </span>'+
                                   '    <span class="wap_2">¥'+(this.price*1).toFixed(1)+'起</span>'+
                                   '     <span class="wap_3">x'+this.people+'</span>'+
                                   '    <span class="wap_3">¥'+(this.price*this.people).toFixed(1)+'起</span>'+
                            '</div>'
                        })
                        $('.wap_content_eat').html(eat_table);  
                        // $('.travel_tot_money').text((eat_tot+hotel_tot+trafficTot).toFixed(2));         
                       /* var priceArr =[{value:eat_tot, name:'餐饮费用'},
                                        {value:trafficTot, name:'交通费用'},
                                        {value:hotel_tot, name:'住宿费用'},
                                        {value:ticket_tot, name:'门票费用'}]
                        renderEchats(priceArr)
                        var p_right_str = '';
                        for(var i=0;i<priceArr.length;i++){
                            p_right_str += '<li class="fl"><span></span>'+priceArr[i].name +' '+(priceArr[i].value).toFixed(2)+'元</li>'
                        }
                        $('.percentBox .p-right ul').html(p_right_str);*/
                /*费用清单 end*/

                /*daylist start*/
                daylist = [];
                day_list_img =[];
                $(res.Schedufing).each(function(i,ele){
                    var that =this;
                    var sch_length = res.Schedufing.length-1;
                    var foodTemp ={};
                        foodTemp.len = this.day_arry.length;
                        foodTemp.food =[];
                    if(i<sch_length){
                        this.day_arry[this.day_arry.length-1].hotel=res.Schedufing[i+1].prevHotel?res.Schedufing[i+1].prevHotel.hotel:this.day_arry[this.day_arry.length-1].hotel;
                    }; //本城市最后一天的hotel
                    $(that.day_arry).each(function(k,ele){
                        var temp =this;
                        var dayMapoint = [];
                        if(!this.hotel){
                            this.hotel={
                                hotel_name:''
                            }
                        }
                        travelHotelArr.push(this.hotel);
                        if(this.eat){
                            foodTemp.food.push(this.eat)
                        }
                       /* if(this.SpotDisSum){
                            this.dis = this.SpotDisSum;
                        }*/
                        $(temp.day).each(function(){
                            dayMapoint.push({'lng':this.this_lng,'lat':this.this_lat})
                        })
                        temp.thisCity = that.this_city;
                        temp.use_time = that.use_time;
                        temp.traffic_ico = that.traffic_ico;
                        temp.city_trc_name = that.city_trc_name;
                        temp.dis = that.dis;
                        temp.mapPosition = dayMapoint;
                        temp.city_image_url = that.city_image_url;
                        temp.two_city = this.two_city?this.two_city:that.day_arry[0].two_city;
                        temp.two_city_Introduction = that.city_Introduction;
                        temp.two_city_abbreviation = that.city_abbreviation;
                        temp.one_city_abbreviation = daylist.length>0?daylist[daylist.length-1].two_city_abbreviation :'';
                        temp.one_city_Introduction = daylist.length>0?daylist[daylist.length-1].two_city_Introduction :'';
                        daylist.push(temp);
                        day_list_img.push(dayMapoint);
                    })
                    travelFoodArr.push(foodTemp);
                })
                /*费用清单 景点门票start*/
                $(daylist).each(function(i,ele){
                    if(!this.day){
                        this.day=[];//有些数据里没有day字段报错
                    }
                    $(this.traffic).each(function(){
                        var hours = deFormatHour(this.tooltime)
                        this.hours = hours;
                        switch(this.city_trc_name.trim())
                            {
                                case '铁路交通':
                                this.traffic_ico = 'date_train'
                                break;
                                case '飞机交通':
                                this.traffic_ico = 'date_air'
                                break;
                                case '汽车交通':
                                this.traffic_ico = 'date_bus'
                                break;
                                default:
                                this.traffic_ico = 'date_other'
                            }
                    }) 
                   

                    if(i==0){   //解决一天多个城市的天数情况
                        this.dayindex  = i;
                    }else{
                         this.dayindex = daylist[i-1].dayindex +1
                    }  
                    if( i>0 &&  daylist[i-1].date == this.date){
                        this.dayindex = daylist[i-1].dayindex
                        
                    }
                   
                    $(ele.day).each(function(){
                        var temp ={};
                        var strt,end,price;
                            temp.ticket=0;
                        if(this.info.attractions_tickets){
                            start = this.info.attractions_tickets.indexOf("成人票：");
                            end = this.info.attractions_tickets.indexOf("元/人"); 
                            price =  (start=="-1"||end=="-1")?0:parseFloat(this.info.attractions_tickets.substring(start+4,end));
                            temp.ticket=Boolean(price)?price:0;
                        }
                        
                        temp.spotName=this.info.spot_name; 
                        temp.type="门票费用";
                        temp.totmoney =  temp.ticket==0?'不详' : '¥' + (res.gailan.adult * temp.ticket) + '起';
                        temp.peopleNum = res.gailan.adult + res.gailan.children;
                        ticket_tot+=res.gailan.adult * temp.ticket;
                        ticket_table += '<div class="list">'+
                                   '   <span class="wap_1">'+
                                   '        <i class="wap_ico hotel"></i>'+temp.spotName+
                                   '    </span>'+
                                   '    <span class="wap_2">¥'+ temp.ticket+'</span>'+
                                   '     <span class="wap_3">x'+temp.peopleNum+'</span>'+
                                   '    <span class="wap_3">'+temp.totmoney+'</span>'+
                            '</div>'
                    })
                })
                console.log(daylist)
                 $('.wap_content_ticket').html(ticket_table);  
                 $('.travel_tot_money').text((eat_tot+hotel_tot+trafficTot+ticket_tot).toFixed(2));
                 var priceArr =[{value:eat_tot, name:'餐饮费用'},
                                        {value:trafficTot, name:'交通费用'},
                                        {value:hotel_tot, name:'住宿费用'},
                                        {value:ticket_tot, name:'门票费用'}]
                        renderEchats(priceArr)
                        var p_right_str = '';
                        for(var i=0;i<priceArr.length;i++){
                            p_right_str += '<li class="fl"><span></span>'+priceArr[i].name +' '+(priceArr[i].value).toFixed(2)+'元</li>'
                        }
                        $('.percentBox .p-right ul').html(p_right_str);

                 /*费用清单 景点门票end*/
                 switch(res.gailan.return_cityInfo.city_trc_name.trim())
                    {
                        case '铁路交通':
                        res.gailan.return_cityInfo.use_time = res.gailan.return_cityInfo.trainTime;
                        break;
                        case '飞机交通':
                        res.gailan.return_cityInfo.use_time = res.gailan.return_cityInfo.flightTime;
                        break;
                        default:
                        res.gailan.return_cityInfo.use_time = res.gailan.return_cityInfo.trafficTime;
                    }
                daylist[daylist.length-1].one_city_Introduction =res.Schedufing[res.Schedufing.length-1].city_Introduction;
                daylist[daylist.length-1].one_city_abbreviation =res.Schedufing[res.Schedufing.length-1].city_abbreviation;
                daylist[daylist.length-1].two_city_Introduction ='';
                daylist[daylist.length-1].two_city_abbreviation ='';
                daylist[daylist.length-1].city_trc_name =res.gailan.return_cityInfo.city_trc_name;
                daylist[daylist.length-1].dis =res.gailan.return_cityInfo.dis;
                daylist[daylist.length-1].use_time =res.gailan.return_cityInfo.use_time;
                var dayListObj = {};
                dayListObj.daylist = daylist;
                var dayListRender = template.compile(dayListTemplate);
                var html = dayListRender(dayListObj);
                    tot_day= daylist.length;
                $('.time_line  .tit1').text(res.gailan.day_num+'天')
                var calendarRender = template.compile(calendarTemplate);
                var calendarHtml = calendarRender(dayListObj);
                $('.flag_before').before(html);
                console.log(daylist);
                $('.day_wap_outer .day_inner').html(calendarHtml);
                // hoverDetailsPopup();
                var calendarHotelStr = '';
                var calendarFoodStr = '';
                
                $(travelHotelArr).each(function(i,ele){
                      /*calendarHotelStr+= '<div class="bottom_hotel_outer fl">'+
                        '<div class="bottom_hotel_list">';
                        if(this.hotel_name!=''){
                            calendarHotelStr += '<span>住</span>'+ this.hotel_name 
                        }
                        if(i==travelHotelArr.length-1){
                            calendarHotelStr += '<span>住</span>温馨的家'
                        }
                       calendarHotelStr+='</div></div>';*/
                    if(this.hotel_name){
                        calendarHotelStr +=  '<div class="hotel_box fl">\
                            <div class="hotel_name">'+this.hotel_name+' <i class="hotel_ico"></i></div>\
                            <div class="toBook">\
                                <div class="book_tit">'+this.hotel_name+'</div>\
                                <div class="tips">地址：'+this.address+' | ¥'+this.LowRate+'起</div>\
                                <div class="clearfix">\
                                    <span class="fl book_btn">去预定</span>\
                                    <span class="fr ico hotel_ico"></span>\
                                    <span class="close_info"></span>\
                                </div>\
                            </div>\
                      </div>'
                  }else{
                    calendarHotelStr += '<div class="hotel_box fl"><div class="no_hotel">暂未安排酒店</div> </div>';
                  }
                    
                });

                $(travelFoodArr).each(function(){
                        var _self = this;
                         calendarFoodStr+='<div style="width:'+(228*this.len+this.len)+'px;" class="bottom_food_outer fl">'+
                            '<div class="bottom_food_list">'
                                $(this.food).each(function(i,ele){
                                   calendarFoodStr+=  i<_self.food.length-1?this.store_name+'、':this.store_name
                                   
                                })
                               calendarFoodStr+='</div></div>';
                })
                
                $('#datebox  .bottom_hotel .hotel_ul').append(calendarHotelStr);
                $('.calendar_pat .bottom_food_box').html(calendarFoodStr);
                    modeldatePointer();
                    calcspotHeight()
                    loadApp()

                  $('.book_right_bar').on('click','.bar',function(){
                        if($(this).hasClass('active')) return false;
                        $(this).addClass('active').siblings().removeClass('active');
                        var index = $(this).attr('index');
                         $("#flipbook").turn("page",index);
                  })
                $('.day_list .map img').each(function(i,ele){
                    renderMap(day_list_img[i],$(this))

                })

                     $('#flipbook .page').each(function(i,ele){
                    
                    if(i%2 ==!0){ 
                        $(this).css({'backgroundColor':'#f0f0f0'})
                    }else{
                        $(this).find('.page_tit').css({'textAlign':'right'})
                    }
                })
               
                /*daylist end*/
                /*f发布行程*/
                $('.issue').on('click',function(){
                    if(issue) return false ;
                    $.post('publish_trip',{'uid':u,'trip_id':trip},function(res){
                        if(res.status=='ok'){
                            $('.issue').addClass('disabled').text('已发布')
                             issue = true ;
                             window.location.href= '/portal/itinerary/tripInfo/'+trip+'.html';
                        }else{
                             alert('行程发布失败');
                        }
                        
                      
                    },'json')
                })
     },'json')
        
       
                                      
                // loadApp()
                function loadApp() {
                    $('#flipbook').turn({
                        // Width
                        width: 1100,
                        // Height
                        height: 660,
                        // Elevation
                        elevation: 300,
                        display: 'double',
                        page:2,//初始页面
                        // pages:10,
                        // Enable gradients
                        gradients: true,
                        // Auto center this flipbook
                        autoCenter: true,
                        when: {
                            turning: function (e, page, view) {
                                var totPage = $("#flipbook").turn("pages")
                                if(page<2||page>(totPage-1)) {
                                    return false;
                                }
                                 $('.day_list .map img').each(function(i,ele){
                                     var index =  $(this).attr('index')
                                     renderMap(day_list_img[index],$(this))

                                })  
                                
                            },
                            turned: function (e, page, view) {
                                $('.book_right_bar .bar').each(function(){
                                    if(page == $(this).attr('index')||page==($(this).attr('index')*1+1)){
                                        $(this).addClass('active').siblings().removeClass('active');
                                    }
                                })
                                var total = $("#flipbook").turn("pages");//总页数                        
                          
                            }
                        }
                    })
                }

		$(window).on('keydown',function(e){
			if(e.keyCode==37){
				$('#flipbook').turn('previous');
			}
			if(e.keyCode==39){
				$('#flipbook').turn('next');
			}
		})
        
        /*$('.new_calendar_pat .day_wap_outer,.calendar_pat .day_wap_outer').on('click','.day_list_title',function(){
            var index = $(this).parent('.day_list').attr('index');
           renderMap(day_list_img[index],$('.cimgMask img'));
           $('.cimgMask').show().on('click',function(){
                $(this).hide();
           })
           $(window).on('keyup',function(event){
                if(event.keyCode==27){
                   $('.cimgMask').hide();
                }
           })
        })*/
         



         var dayListTemplate = '{{each daylist as value i}}\
                    <div class="page">\
                        <div class="page_inner page_list">\
                            <div class="page_head clearfix">\
                                <span class="fl">日程安排</span><span class="fr">袋鹿旅行</span>\
                            </div>\
                            {{if i==0}}\
                            <div class="page_tit">\
                                <div class="book_title">日程安排</div>\
                                <div class="">\
                                    <span>SCHEDULE</span>\
                                </div>\
                            </div>\
                            {{/if}}\
                            <div class="day_list">\
                                <div class="day_list_tit city">\
                                    <span class="day_num">D{{value.dayindex+1}}</span>\
                                    <span class="city_line">{{value.thisCity}}</span>\
                                    {{if value.start_time}}\
                                    <span class="time_line">{{value.start_time + " - " + value.end_time }}</span>\
                                    {{else}}\
                                    <span class="time_line">{{if i==0}}13:00{{else}}09:00{{/if}} -19:00</span>\
                                    {{/if}}\
                                    <span class="date fr">{{value.date}}</span>\
                                </div>\
                                <div class="map">\
                                    <img index = "{{i}}" src="" alt="">\
                                </div>\
                                <div class="inner_box">\
                                    {{if value.one_city}}\
                                    <div class="inner_tit circle">\
                                        <span class="cityName">{{value.one_city}}</span> <span class="tip">{{value.one_city_abbreviation}}</span>\
                                    </div>\
                                    <div class="inner_msg">{{value.one_city_Introduction}}</div>\
                                    <div class="point city2city">\
                                        <i class="wap_ico {{value.traffic_ico}}"></i>\
                                        <span class="p_line">{{value.one_city}}-{{value.two_city}}</span> | {{value.city_trc_name}}.{{value.dis}}公里·{{value.use_time}}小时\
                                    </div>\
                                    <div class="inner_tit circle">\
                                        <span class="cityName">{{value.two_city}}</span> <span class="tip">{{value.two_city_abbreviation}}</span>\
                                    </div>\
                                    <div class="inner_msg">{{value.two_city_Introduction}}</div>\
                                    <div class="p_line" style="margin:20px 0">\
                                        <i class="wap_ico taxi"></i>\
                                        接{{value.city_trc_name}}服务\
                                    </div>\
                                    {{/if}}\
                                    {{if value.hotel.hotel_name}}\
                                    <div class="hotel_wap">\
                                        <div class="inner_tit point">\
                                            <span class="cityName hotel">{{value.hotel.hotel_name}}</span> \
                                        </div>\
                                        <div class="deeptime">\
                                            入住日期 {{value.date}}\
                                        </div>\
                                        <div class="">联系电话：<span>{{value.hotel.tel}}</span></div>\
                                        <div class="">详细地址：<span>{{value.hotel.address}}</span></div>\
                                    </div>\
                                    {{/if}}\
                                    <div class="spot_wap">\
                                        {{each value.day as item k}}\
                                        <div class="spot_list">\
                                            <div class="inner_tit">\
                                                <em>{{k+1}}</em>\
                                                <span class="cityName">{{item.info.spot_name}}</span> <span class="tip">游玩时间 {{item.this_playtime}}</span>\
                                            </div>\
                                            <div class="spot_info">\
                                                <div class="clearfix" style="margin-bottom: 10px;">\
                                                    <div class="img_box fl">\
                                                        <img src="{{item.info.spot_image_url}}" alt="">\
                                                    </div>\
                                                    <div class="fr spot_msg">\
                                                        <div class="on_time">营业时间：<span>{{item.info.business_hours}}</span></div>\
                                                        <div class="one_pay">人均消费：{{#item.info.attractions_tickets}}</div>\
                                                        <div class="address">详细地址：<span>{{item.info.address}}</span></div>\
                                                        <div class="phone">联系电话：<span>{{item.info.phone}}</span></div>\
                                                    </div>\
                                                </div>\
                                                <div>{{item.info.absture}}</div>\
                                            </div>\
                                        </div>\
                                        {{/each}}\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                    </div>\
                    {{/each}}'
        var overviewTemplate = '{{each go_city_array as value i}}\
                                    <div class="city_catalog">\
                                    <i class="zxq_ico">{{i+1}}</i>\
                                    <span>{{value.city_name}}</span>\
                                        <div class="day fr">\
                                        {{each value.city_daynum_arr as item k}}\
                                            <span>D{{item}}</span>\
                                        {{/each}}\
                                        </div>\
                                    </div>\
                                {{/each}}'

        var calendarTemplate='{{each daylist as value i}}\
            <li class="daylist fl">\
                <div class="daytit" >\
                    <div class="daynum">第{{value.dayindex+1}}天</div>\
                    <div class="tit_city">{{value.date}} {{value.weeks||""}} |  {{value.thisCity}}</div>\
                </div>\
                <div class="distance">里程 · {{if value.SpotDisSum}} {{value.SpotDisSum+"公里"}} {{else}} 不详{{/if}} <span class="traffic_type hide">包车</span></div>\
                <div class="no_with start_time" start_time="{{value.start_time}}">\
                </div>\
                {{if value.traffic}}\
                <div class="block traffic_block" style="min-height:64px; height:{{value.traffic[0].hours*40}}px">\
                    <div class="block_in traff" style="">\
                        <div class="in_title">{{value.traffic[0].one_city}} — {{value.traffic[0].two_city}}</div>\
                        <div class="tip">{{value.traffic[0].city_trc_name}} · {{value.traffic[0].tooltime}}</div>\
                        <i class="ico {{value.traffic[0].traffic_ico}}"></i>  \
                    </div>\
                    <div class="toBook">\
                        <div class="book_tit">{{value.traffic[0].one_city}} — {{value.traffic[0].two_city}}</div>\
                        <div class="tips">{{value.traffic[0].city_date}} | {{value.traffic[0].city_trc_name}}·{{value.traffic[0].dis}}公里·{{value.traffic[0].tooltime}} | ¥{{value.traffic[0].price}}起</div>\
                        <div class="clearfix">\
                            <span class="fl book_btn">去预定</span>\
                            <span class="fr ico date_train"></span>\
                            <span class="close_info"></span>\
                        </div>\
                    </div>\
                </div>\
                {{/if}}\
                {{each value.day as item key}}\
                {{if item.this_tag_time>3}}\
                    <div class="block datespot" style="height:{{40*item.this_tag_time}}px;" city_id ={{item.city_id}} spot_name={{item.this_name}} lng={{item.this_lng}} lat={{item.this_lat}} this_type={{item.this_type}} this_floor_index={{item.this_floor_index}}>\
                        <div class="block_in gai" {{if item.eat_info&&item.eat_info.length>0}} style="padding-bottom:52px;"{{/if}}>\
                            <div class="block_in_up">\
                                <div class="in_title"><span>{{key+1}}.</span>{{item.info.spot_name}}</div>\
                                <div class="tip">景点 · 游玩 {{item.this_playtime}}</div>\
                                <i class="ico sport"></i>   \
                            </div>\
                            {{if item.eat_info&&item.eat_info.length>0}}\
                            <div class="block_in_down">\
                                <div class="food_inner">\
                                {{each item.eat_info as list j}}\
                                <div class="in_title_s">{{list.name}}</div>\
                                <div class="tip_s">美食 · 人均 ¥{{list.per_capita}} 起</div>\
                                {{/each}}\
                                </div>\
                                <i class="ico cy"></i>  \
                            </div>\
                            {{/if}}\
                        </div>\
                    </div>\
                    <div class="no_with" style="height: 16px;"></div>\
                {{else}}\
                <div class="block datespot" style="height:{{40*item.this_tag_time}}px;" city_id ={{item.city_id}} spot_name={{item.this_name}} lng={{item.this_lng}} lat={{item.this_lat}} this_type={{item.this_type}} this_floor_index={{item.this_floor_index}}>\
                    <div class="gai block_in clearfix" style="">\
                        <div class="block_in_left fl" {{ if item.eat_info &&item.eat_info.length>0}} style="width: 116px;"{{/if}}>\
                            <div class="in_title_s"><span>{{key+1}} .</span>{{item.info.spot_name}}</div>\
                            <div class="tip_s">景点 · 游玩 {{item.this_playtime}}</div>\
                            <i class="ico sport"></i>   \
                        </div>\
                        {{if item.eat_info&&item.eat_info.length>0}}\
                        <div class="block_in_right fr" style="width: 44px; padding: 10px 12px;">\
                            <div class="food_inner">\
                            {{each item.eat_info as list j}}\
                                <div class="in_title_s dis_none">{{list.name}}</div>\
                                <div class="tip_s dis_none">美食 · 人均 ¥{{list.per_capita}} 起</div>\
                            {{/each}}\
                            </div>\
                            <i class="ico cy"></i>   \
                        </div>\
                        {{/if}}\
                    </div>\
                </div>\
                <div class="no_with" style="height: 16px;"></div>\
                {{/if}}\
                {{/each}}\
                {{if value.day.length==0}}\
                    <div class="notravel">当天没有行程</div>\
                {{/if}}\
                {{if value.traffic}}\
                {{each value.traffic as traffic k}}\
                    {{if k>0}}\
                    <div class="block" style="min-height:64px; height:{{traffic.hours*40}}px">\
                        <div class="block_in traff" style="">\
                            <div class="in_title">{{traffic.one_city}} — {{traffic.two_city}}</div>\
                            <div class="tip">{{traffic.city_trc_name}} · {{traffic.tooltime}}</div>\
                            <i class="ico date_train"></i>  \
                        </div>\
                        <div class="toBook">\
                            <div class="book_tit">{{traffic.one_city}} — {{traffic.two_city}}</div>\
                            <div class="tips">{{traffic.city_date}} | {{traffic.city_trc_name}}·{{traffic.dis}}公里·{{traffic.tooltime}} | ¥{{traffic.price}}起</div>\
                            <div class="clearfix">\
                                <span class="fl book_btn">去预定</span>\
                                <span class="fr ico {{traffic.traffic_ico}}"></span>\
                                <span class="close_info"></span>\
                            </div>\
                        </div>\
                    </div>\
                    {{/if}}\
                {{/each}}\
                {{/if}}\
            </li>\
        {{/each}}'
        /*图片地图 start*/
       function renderMap (pointArr,selector,isCitys){
            // var pointArr= [{'lng':109.501375,'lat':26.128291},{'lng':114.335359,'lat':30.517291},{'lng':116.378816,'lat':28.200323},{'lng':120.158113,'lat':30.004871}]
            var lngarr=[];
            var latarr=[];
            for(var i=0;i<pointArr.length;i++){
                lngarr.push(pointArr[i].lng)
                latarr.push(pointArr[i].lat)
            }
            var center={}
            center.lng =(Math.max.apply(null,lngarr )+Math.min.apply(null,lngarr))/2;
            center.lat =(Math.max.apply(null,latarr )+Math.min.apply(null,latarr))/2;
            var markerstr = '';
            var pathstr = '';
            if(pointArr.length<1){
                selector.attr('src','/static/v1/img/nodata_day.png')
                return false ;
            }
            if(isCitys){ //游玩城市概览 显示出发城市
              markerstr = '&markers=icon:http://www.dailuer.com/static/v1/img/map/departureicon.png|'+pointArr[0].lat+','+pointArr[0].lng;
              for(var i= 0;i<pointArr.length-1;i++){
                markerstr += '&markers=color:red|label:'+(i +1) +'|'+pointArr[i+1].lat+','+pointArr[i+1].lng;
                pathstr += '|'+pointArr[i+1].lat+','+pointArr[i+1].lng;
              }
            }else{
              for(var i= 0;i<pointArr.length;i++){
                markerstr += '&markers=color:red|label:'+(i +1) +'|'+pointArr[i].lat+','+pointArr[i].lng;
                pathstr += '|'+pointArr[i].lat+','+pointArr[i].lng;
              }
            }
            /*for(var i= 0;i<pointArr.length;i++){
                markerstr += '&markers=color:red|label:'+(i+1) +'|'+pointArr[i].lat+','+pointArr[i].lng;
                pathstr += '|'+pointArr[i].lat+','+pointArr[i].lng;
            }*/
            //   AIzaSyAC3WnNnGZrYPuklsqw19790DmJ99c5xNU
            var imgsrc = 'http://maps.google.cn/maps/api/staticmap?key=AIzaSyDyRjVndlLtlpWVIg_RSfgGYLUUvclNLGw&center='+center.lat+','+center.lng +'zoom=15&size=678x400&maptype=roadmap'+markerstr+'&path=color:0xFF0000|weight:5'+pathstr;
            // var imgsrc = 'http://maps.google.cn/maps/api/staticmap?center='+center.lat+','+center.lng +'zoom=1&size=678x400&maptype=roadmap'+markerstr+'&path=color:0xFF0000|weight:5'+  pathstr +'&key=AIzaSyBcGy-zXcXLVGAmVvG3IJsnw_WVVIH8cOY&signature=VWWPUMyKSepuBHEedSs7bSGC0Y0=';
                imgsrc = encodeURI(imgsrc)
                // var keystr ='&signature=KVcIQXhgPfSLBY-FQZjznrpuYvg='
                // imgsrc = imgsrc + keystr
            selector.attr('src',imgsrc)
    }

     /*图片地图end*/

      function renderEchats(priceArr){
             // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('p-left'));
 
        // 指定图表的配置项和数据

                    var option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        legend: {
                            orient: 'vertical',
                            x: 'right',
                            data:['餐饮费用','交通费用','住宿费用','门票费用']
                        },
                        color:['#975ee4','#fbd336','#3aa0ff','#f2637a'],
                        series: [
                        {
                            name:'费用类型',
                            type:'pie',
                            radius:['50%', '65.5%'],
                            avoidLabelOverlap: false,
                            label: {
                             normal: {
                                show: true,
                                z:1,
                                position: 'center',
                                formatter:function(){
                                    return '总费用\n '+(priceArr[0].value+priceArr[1].value+priceArr[2].value+priceArr[3].value).toFixed(2)
                                },
                                textStyle: {
                                    fontSize: '20',
                                    fontWeight: 'bold',
                                    backgroundColor:'#fff',
                                    textAlign:'center',

                                }

                            },
                            emphasis: {
                                show: true,
                                textStyle: {
                                    fontSize: '20',
                                    fontWeight: 'bold',
                                    backgroundColor:'#fff',
                                    padding: 20
                                },
                                formatter:function(p){
                                    return p.data.name
                                },
                                z:2
                            }
                        },
                        labelLine: {
                            normal: {
                                show: false
                            }
                        },
                        data:priceArr
                    }
                    ]
                };


        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
    }
    $('.app_btn,.ewm').on('click',function(){
        $('.ewm').toggleClass('scale');
    })
     
    $('.left_tab span , .downshare').on('click',function(){
        $('.hotelmsg').hide();
        if($(this).hasClass('active')) return false;
        $(this).addClass('active').siblings().removeClass('active');
        switch($(this).attr('tar'))
                    {
                        case 'books':
                       $('.book_box').show().siblings().hide()
                        break;
                        case 'share':
                       $('.down2share').show().siblings().hide()
                        break;
                        case 'date':
                       $('.calendar').show().siblings().hide()
                        break;
                    }
        $('.downshare').removeClass('active');
    })
    
     $('.download').on('click',function(){
            window.open('/portal/itinerary/downpdf.html?them='+u + '&trip='+trip);
    })

     /*日历模式*/
     var calendarIndex = 0;
     var tot_day ;
     $('.new_calendar_pat .dayNext').on('click',function(){
        if(calendarIndex >= (tot_day-6)) return false;
        $(this).siblings('.dayPrev').removeClass('dis')
        calendarIndex ++;
        if(calendarIndex >= (tot_day-6)){
             $(this).addClass('dis');
        }
        var range = -calendarIndex* 171 +'px';
        $('.day_inner').css({'transform':'translateX('+range+')'})
        $('.bottom_hotel .hotel_ul').css({'transform':'translateX('+range+')'})
     })
     $('.new_calendar_pat .dayPrev').on('click',function(){
        if(calendarIndex ==0) return false;
        $(this).siblings('.dayNext').removeClass('dis')
        calendarIndex --
        if(calendarIndex ==0){
            $(this).addClass('dis')
        }
        var range = -calendarIndex* 171 +'px';
        $('.day_inner').css({'transform':'translateX('+range+')'})
        $('.bottom_hotel .hotel_ul').css({'transform':'translateX('+range+')'})
     })

     $('.remark .tips').on('click',function(){
        $('.remark_mask').show();
     })
     $('.cancel').on('click',function(){
        $('.remark_mask').hide();
     })
/*
     $('.day_inner').on('click','.list_type ',function(){
        $('.spotmsg').hide();
        var d_index = $(this).parents('.day_list').attr('index');
        var s_index = $(this).attr('index');
        var bgc = $(this).css('backgroundColor');
        var top = $(this).offset().top;
        var left = $(this).offset().left+229;
        if(!s_index) return false ;
        var foodStr = '';
        var foodArr = daylist[d_index].day[s_index].eat_info? daylist[d_index].day[s_index].eat_info:[];
            $(foodArr).each(function(){
                foodStr+=this.name+' ';
            })
            foodStr = foodStr?foodStr:'不详';
        $('.spotmsg .title .tit_m').html(daylist[d_index].day[s_index].info.spot_name);
        if(daylist[d_index].day[s_index].info.suit_season==''){
            $('.spotmsg .play_suit').hide();
        }
        var attractions_tickets = daylist[d_index].day[s_index].info.attractions_tickets?daylist[d_index].day[s_index].info.attractions_tickets:'免费';
        $('.spotmsg .play_time').html('适玩时间：'+daylist[d_index].day[s_index].this_playtime);
        $('.spotmsg .play_suit').html('适玩月份：'+daylist[d_index].day[s_index].info.suit_season);
        $('.spotmsg .play_cost').html('景点门票：'+attractions_tickets);
        $('.spotmsg .play_open').html('开放时间：'+daylist[d_index].day[s_index].info.business_hours);
        $('.spotmsg .foodlist').html('附近美食：'+foodStr);
        $('.spotmsg').show().css({'top':top,'left':left}).find('.title').css({'backgroundColor':bgc});
     })*/
     /*$('.close').on('click',function(){
            $(this).parents('.spotmsg').hide();
     })*/

   /* $('.day_wap_outer').on('scroll',function(){
        $('.spotmsg').hide();
        if($(this).scrollTop()>0){
            $('.new_calendar_pat .prev_btn,.new_calendar_pat .next_btn').hide();
        }else{
            $('.new_calendar_pat .prev_btn,.new_calendar_pat .next_btn').show();
        }
    });*/

     function calcspotHeight (){
        var oneMinute = 47/60;
        var reg = /[\u4e00-\u9fa5]/g; //截取时间单位
        var names = name.match(reg);
      

       /* $('.calendar_pat .use_time .time').each(function(){
            var this_time = $(this).html(); 
            var this_height = 0;
            var unit = this_time.match(reg)
            if(unit){
                unit = unit.join("");
                switch(unit)
                {
                    case '小时':
                    this_height = parseFloat(this_time)*60*oneMinute ;
                    break;
                    case '天':
                     this_height = parseFloat(this_time)*10*60*oneMinute ;
                    break;
                    default:
                    this_height = parseFloat(this_time)*10*60*oneMinute ;
                }
            }else{
               this_height =63 ;
            }

           $(this).parents('.list_type').css({'height':this_height+'px'});
           if(this_height>=54){
                $(this).parents('.list_type').find('.tit').css({paddingTop:'10px'});
           }
           if(this_height<=44){

           }

        })*/

        

        $('.new_calendar_pat .no_with').each(function(){
            var mbt = getHour('05:00:00',$(this).attr('start_time'))*38.6666;
            $(this).css('height',mbt+'px');
        })

         /*$('.new_calendar_pat .use_time .time').each(function(){
            var this_time = $(this).html(); 
            var this_height = 0;
            var unit = this_time.match(reg)
            if(unit){
                unit = unit.join("");
                switch(unit)
                {
                    case '小时':
                    this_height = parseFloat(this_time)*60*oneMinute ;
                    break;
                    case '天':
                     this_height = parseFloat(this_time)*10*60*oneMinute ;
                    break;
                    default:
                    this_height = parseFloat(this_time)*10*60*oneMinute ;
                }
            }else{
               this_height =63 ;
            }

           $(this).parents('.list_type').css({'height':this_height+'px'});
           if(this_height>=54){
                $(this).parents('.list_type').find('.tit').css({paddingTop:'10px'});
           }
           if(this_height<=44){
                $(this).parents('.list_type').find('.tit').addClass('ellip');
           }

        })*/

     }
     function modeldatePointer (){
            $('.block.datespot').each(function(){

                if($(this).height()<80){
                    $(this).find('.ico').not('.cy').hide()
                }
                if($(this).height()<40){
                    $(this).find('.ico.cy').hide()
                    $(this).find('.block_in_left').css({'padding':'7px 12px'})
                    $(this).find('.block_in_right').css({'padding':'7px 12px'})
                }
                if($(this).find('.block_in_right').length==0 && $(this).height()>40){
                     $(this).find('.ico').not('.cy').show();
                }
            })

            var listWidth =  $('.datelist_box .daylist').length*172;
             $('.datelist_box').width(listWidth);
             $('.bottom_hotel .hotel_ul').width(listWidth)
            $('.block_in_left').hover(function(){
                if($(this).siblings('.block_in_right').length<=0){
                    return false;
                }
                $(this).stop().animate({'width':'162px'},300,'easeOutQuad');
                $(this).siblings('.block_in_right').stop().animate({'width':0,'padding':'0'},300,'easeOutQuad')
             },function(){
                if($(this).siblings('.block_in_right').length<=0){
                    return false;
                }
                $(this).stop().animate({'width':'116px'},300,'easeInQuad');
                if($(this).parents('.block.datespot').height()<=40){
                    $(this).siblings('.block_in_right').stop().animate({'width':'44px','padding':'7px 12px'},300,'easeInQuad');
                }else{
                     $(this).siblings('.block_in_right').stop().animate({'width':'44px','padding':'10px 12px'},300,'easeInQuad');
                }
             });
             $('.block_in_right').hover(function(){
                var _self = this;
                $(this).find('.in_title_s').stop().fadeIn();
                $(this).find('.tip_s').stop().fadeIn(200);
                $(this).stop().animate({'width':'162px'},300,'easeOutQuad').find('.ico').stop().fadeOut(200,function(){
                    $(_self).find('.ico').css({'margin':'0','bottom':'12px','right':'12px'}).stop()
                    if($(_self).parents('.block.datespot').height()>=40){
                        $(_self).find('.ico').fadeIn(200)
                    }
                });
                $(this).siblings('.block_in_left').stop().animate({'width':0,'padding':0},300,'easeOutQuad')
             },function(){
                var _self = this;
                $(this).find('.in_title_s').stop().fadeOut()
                $(this).find('.tip_s').stop().fadeOut()
                $(this).stop().animate({'width':'44px'},300,'easeInQuad',function(){
                    $(_self).find('.ico').css({'margin':'0px -11px -11px 0','bottom':'50%','right':'50%'});
                });
                if($(_self).parents('.block.datespot').height()<=40){
                    $(this).siblings('.block_in_left').stop().animate({'width':'116px','padding':'7px 12px'},300,'easeInQuad')
                }else{
                    $(this).siblings('.block_in_left').stop().animate({'width':'116px','padding':'10px 12px'},300,'easeInQuad')

                }
            });
    
            // 上下布局
            
             $('.block_in_up').hover(function(){
                if($(this).siblings('.block_in_down').length<=0){
                    return false;
                }
                var blockHeight = $(this).parents('.block').height();
                $(this).siblings('.block_in_down').find('.ico.cy').hide();
                $(this).stop().animate({'height':blockHeight},300,'easeOutQuad');
                $(this).siblings('.block_in_down').stop().animate({'height':0,'padding':'0 12px'},300,'easeOutQuad')
             },function(){
                if($(this).siblings('.block_in_down').length<=0){
                    return false;
                }
                $(this).siblings('.block_in_down').find('.ico.cy').show(300);
                $(this).stop().animate({'height':'100%'},300,'easeInQuad');
                $(this).siblings('.block_in_down').stop().css({}).animate({'height':'52px','padding':'8px 12px'},300,'easeInQuad')
             });
    
            $('.block_in_down').hover(function(){
                var blockHeight = $(this).parents('.block').height();
                $(this).stop().animate({'height':blockHeight},300,'easeOutQuad');
                $(this).siblings('.block_in_up').stop().animate({'height':0,'padding':'0 12px'},300,'easeOutQuad')
             },function(){
                $(this).stop().animate({'height':'52px','padding':'8px 12px'},300,'easeInQuad');
                $(this).siblings('.block_in_up').stop().css({}).animate({'height':'100%','padding':'10px 12px'},300,'easeInQuad')
            });

            $('.block_in.traff').on('click',function(){
                $(this).hide().siblings('.toBook').show()  
            })

            $('.block .toBook .close_info').on('click',function(){
                $(this).parents('.toBook').hide().siblings('.block_in').show()  
            })

            $('.hotel_box .hotel_name').on('click',function(){
                  var top = $(this).parents('.hotel_box').offset().top-$(document).scrollTop()-65;
                  var botom = $(this).parents('.hotel_box').offset().bottom;
                  var left = $(this).parents('.hotel_box').offset().left;
                var html = $(this).siblings('.toBook').clone();
                $('.hotelmsg').css({'top':top+'px','left':left+'px'}).show();
                $('.hotelmsg').html(html);
            })

            $('.hotelmsg').on('click','.close_info',function(){
                $('.hotelmsg').hide();     
            })

            $('.datelist_box').on('mousemove', '.block_in',function(e){
                var offset = $(this).offset()
                var x = e.pageX - offset.left
                var y = e.pageY - offset.top
                
                var centerX = $(this).outerWidth() /2
                var centerY = $(this).outerHeight() /2 
                
                var deltaX = x - centerX
                var deltaY = y - centerY
                
                var percentX = deltaX / centerX
                var percentY = deltaY / centerY
                var deg = 10

                $(this).css({
                    transform: 'rotateX('+deg*percentY + 'deg)'+
                    ' rotateY('+deg*-percentX+'deg)'
                    })
            })

            $('.datelist_box').on('mouseleave', '.block_in',function(){
              $('.block_in').css({
                transform: ''
              })
            })
        }

     function getHour(s1, s2) {
        s1= s1+':00'
        s2= s2+':00'
        var reDate = /\d{4}-\d{1,2}-\d{1,2} /;
        s1 = new Date((reDate.test(s1) ? s1 : '2017-1-1 ' + s1 ).replace(/-/g, '/'));
        s2 = new Date((reDate.test(s2) ? s2 : '2017-1-1 ' + s2 ).replace(/-/g, '/'));
        var ms = s2.getTime() - s1.getTime();
        if (ms < 0) return 0;
        return ms / 1000 / 60 / 60;
    }
    //自己注意传递要么都带日期，要么都不带，否则计算出来的不对
    // console.log(getHour('2017-8-23 12:05:05', '2017-8-25 10:05:05'))
    // console.log(getHour('05:00:00', '08:30:00'))

    function deFormatHour(time) {
        var hourIndex = time.indexOf('小时');
        var minuteIndex = time.indexOf('分钟');
        var hours ;
        if(hourIndex==-1 && minuteIndex!=-1){
            hours  = time.substring(0,minuteIndex)/60
        }
        if(hourIndex!=-1 && minuteIndex!=-1){
            hours =time.substring(0,hourIndex)-0 +  time.substring(hourIndex+2,minuteIndex)/60-0
        }
       return hours
    }

      // 景点详情 start

    /*rwpopup_tab2*/
    $('.datebox_inner').on('click','.block_in_up,.block_in_left',function(){
       
        var query = {};
            query.this_floor_index = $(this).parents('.datespot').attr('this_floor_index');
            query.this_type = $(this).parents('.datespot').attr('this_type');
            query.lat = $(this).parents('.datespot').attr('lat');
            query.lng = $(this).parents('.datespot').attr('lng');
            query.city_id = $(this).parents('.datespot').attr('city_id');
            query.spot_name = $(this).parents('.datespot').attr('spot_name');
        $.post('LookDetail',query,function(res){
            if(!res.status){
                layer.msg('暂无景点详情')
            }
            $('.details_popup_box').show();
               var data = res.data;
                maskFn.detailsPopup(data,1)
                $(".popup_img_box").on('click', ".last_li_img,li", function () {
                $(".more_pic_box").fadeIn();
                    maskFn.morePictures(data.spot)
                });
    
                $(".pic_hide").click(function () {
                        $(".more_pic_box").fadeOut();
                        $(".gallery-top").html("");
                        $(".gallery-thumbs").html("");
                });
        },'json').error(function(){
            layer.msg('暂无景点详情')
        })

    })
    $('.details_popup_box .shut_down ').on('click',function(){
        $(this).parents('.details_popup_box').hide();
    })

    $('.details_popup_tab .tab_tit').on('click',function(){
        var type = $(this).attr('type');
        var left =  $(this).position().left
        $('.details_popup_tab_active').animate({'left':left},200);
        $('.rwpopup_tab'+type).show().siblings('.tab_content').hide();
    })

// maskFn.details_popup()
    
    var maskFn={
           //景点详情 弹出程
        detailsPopup: function (data, id_index) {
            var spot_data = data.spot
            // var img_length = spot_data.image_url.length;
            //top
            $(".rw_top_details_text").find(".p1").html(spot_data.spot_name).end()
                .find(".details_time").html(spot_data.play_time).end()
                .find(".suit_season").html(spot_data.suit_season).end()
                .find(".suit_time").html(spot_data.suit_time).end()
                .find(".tel").html(spot_data.phone).end()
                .find(".address").html(spot_data.address).end();
            //图片
             maskFn.popup_img(spot_data)
            //摘要介绍
            $(".js_details_popup_main .rwpopup_tab1").find(".spot_Introduction").html(spot_data.introduction).end()
                .find(".type").html(spot_data.type).end()
                .find(".suit_season").html(spot_data.suit_season).end()
                .find(".suit_time").html(spot_data.suit_time).end()
                .find(".play_time").html(spot_data.play_time).end()
                .find(".phone").html(spot_data.phone).end()
                .find('.address_name').html(spot_data.address).end()
                .find(".attractions_tickets").html(spot_data.attractions_tickets).end()
                .find(".update_time").html(spot_data.release_time);
            //景区景点
            if (data.cultural != undefined) {
                if (data.cultural.length > 0) {
                    $(".js_cultural").show();
                } else {
                    $(".js_cultural").hide();
                };
            } else {
                $(".js_cultural").hide();
            }

            if(!data.tuijian){
                data.tuijian={
                    'food':[],
                    'jingdian':[],
                    'shop':[]
                }
                $(".rwpopup_tab3_ul").html("暂无数据");
            }

            var rwpopup_tab2_tem = '<ul>\
                                        {{each cultural as value i}}\
                                        <li class="clearfix">\
                                            <div class="img_box">\
                                                <img src="{{value.img_url}}" alt="">\
                                            </div>\
                                            <div class="popup_tab_content">\
                                                <div><span class="spot_name">{{value.spot_name}}</span><span class="spot_time">适玩{{value.play_time}}</span></div>\
                                                <div class="spot_details">{{value.introduction}}</div>\
                                                <div class="spot_address">地址：<span>{{value.address}}</span></div>\
                                            </div>\
                                        </li>\
                                        {{/each}}\
                                    </ul>';
            var rwpopup_tab2_render = template.compile(rwpopup_tab2_tem);
            var rwpopup_tab2_html = rwpopup_tab2_render(data);
            $(".rwpopup_tab2").html(rwpopup_tab2_html);
            //附近景点
            var tuijian_data = data.tuijian
            var rwpopup_tab3_tem = '{{each food as value i}}\
                                    <li class="clearfix js_tj_food_list" id="tj' + id_index + '_food_{{i}}" data-lat="{{value.latitude}}" data-lng="{{value.longitude}}" data-per_capita="{{value.per_capita}}">\
                                        <div class="img_box">\
                                            <img src="{{value.img_url}}" alt="">\
                                        </div>\
                                        <div class="popup_tab_content">\
                                            <div><span class="spot_name">{{value.store_name}}</span></div>\
                                            <div class="type_box">\
                                                <div class="foot">{{value.type}}</div>\
                                                <div class="per">人均￥<span class="js_pernum">{{value.per_capita}}</span></div>\
                                                <div class="distance">距离<span class="js_distance">{{value.distance}}</span></div>\
                                            </div>\
                                            <div>地址：<span class="jsaddress">{{value.address}}</span></div>\
                                            <div>电话：<span class="jstel">{{value.phone}}</span></div>\
                                            <div>营业时间：<span class="jstime">{{value.business_hours}}</span></div>\
                                        </div>\
                                        <div class="go js_tj_food_go dis_none">我想去</div>\
                                    </li>\
                                    {{/each}}\
                                    {{each jingdian as value i}}\
                                    <li class="clearfix tj_jDshop_list" data-time = "{{value.tag_time}}" id="tj' + id_index + '_jingdian_{{i}}" data-lat="{{value.latitude}}" data-lng="{{value.longitude}}">\
                                        <div class="img_box">\
                                            <img src="{{value.img_url}}" alt="">\
                                        </div>\
                                        <div class="popup_tab_content">\
                                            <div><span class="spot_name">{{value.spot_name}}</span></div>\
                                            <div class="dis_none time_num">{{value.play_time}}</div>\
                                            <div class="type_box">\
                                                <div class="foot">人文景观</div>\
                                                <div class="distance">距离<span class="js_distance">{{value.distance}}</span></div>\
                                            </div>\
                                            <div>地址：<span class="jsaddress">{{value.address}}</span></div>\
                                            <div>电话：<span class="jstel">{{value.phone}}</span></div>\
                                            <div>开放时间：<span class="jstime">{{value.meal_time}}</span></div>\
                                        </div>\
                                        <div class="go tj_jDshop_go dis_none">我想去</div>\
                                    </li>\
                                    {{/each}}\
                                    {{each shop as value i}}\
                                    <li class="clearfix tj_jDshop_list" data-time = "{{value.tag_time}}" id="tj' + id_index + '_shop_{{i}}" data-lat="{{value.latitude}}" data-lng="{{value.longitude}}">\
                                        <div class="img_box">\
                                            <img src="{{value.img_url}}" alt="">\
                                        </div>\
                                        <div class="popup_tab_content">\
                                            <div><span class="spot_name">{{value.shopping_name}}</span></div>\
                                            <div class="dis_none time_num">{{value.shopping_time}}</div>\
                                            <div class="type_box">\
                                                <div class="foot">{{value.type}}</div>\
                                                <div class="distance">距离<span class="js_distance">{{value.distance}}</span></div>\
                                            </div>\
                                            <div>地址：<span class="jsaddress">{{value.address}}</span></div>\
                                            <div>电话：<span class="jstel">{{value.phone}}</span></div>\
                                            <div>营业时间：<span class="jstime">{{value.business_hours}}</span></div>\
                                        </div>\
                                        <div class="go tj_jDshop_go dis_none">我想去</div>\
                                    </li>\
                                    {{/each}}';
            var rwpopup_tab3_render = template.compile(rwpopup_tab3_tem);
                data.food = data.food?data.food:[];
                data.jingdian = data.jingdian?data.jingdian:[];
                data.shop = data.shop?data.shop:[];
            var rwpopup_tab3_html = rwpopup_tab3_render(tuijian_data);
            if (tuijian_data.food.length == 0 && tuijian_data.jingdian.length == 0 && tuijian_data.shop.length == 0) {
                $(".rwpopup_tab3_ul").html("暂无数据");
            } else {
                $(".rwpopup_tab3_ul").html(rwpopup_tab3_html);
            };

        },
        //相册
        morePictures: function (spot_data) {
            // console.log(spot_data)
            $(".swiper-wrapper").removeAttr("style")
            $(".gallery-thumbs").html("");
            $(".gallery-top").html("");
            var img_data = spot_data.image_url;
            var img_length = img_data.length;
            var tab_text = $(".r_top_tab_box").find("li.active").text();
            if (tab_text == "美食街区") {
                $(".content_name").html(spot_data.food_court_name);
                $(".content_p").html(spot_data.absture);
            } else if (tab_text == "必吃美食" || tab_text == "本土美食") {
                $(".content_name").html(spot_data.store_name);
                $(".content_p").html(spot_data.Introduction);
            } else if (tab_text == "本土特产" || tab_text == "土特产店" || tab_text == "购物商圈") {
                $(".content_name").html(spot_data.shopping_name);
                $(".content_p").html(spot_data.absture);
            } else {
                $(".content_name").html(spot_data.spot_name);
                $(".content_p").html(spot_data.absture);
            }

            var img_top_tem = '<div class="swiper-wrapper">\
                                    {{each image as value i}}\
                                    <div class="swiper-slide" style="background-image:url({{value.url}})">\
                                        <div class="img_text_box">上传于&nbsp{{release_time}}&nbsp·by&nbsp;&nbsp;{{value.name}}<span class="js_byName"></span></div>\
                                    </div>\
                                    {{/each}}\
                                </div>\
                                <div class="img_text_box"><div class="swiper-pagination"></div></div>';
            var img_top_render = template.compile(img_top_tem);
            var img_top_html = img_top_render(spot_data);
            $(".gallery-top").html(img_top_html);


            var img_thumbs_tem = '<div class="swiper-wrapper">\
                                    {{each image_url as value i}}\
                                        <div class="swiper-slide" style="background-image:url({{value}})"></div>\
                                    {{/each}}\
                                 </div>';
            var img_thumbs_render = template.compile(img_thumbs_tem);
            var img_thumbs_html = img_thumbs_render(spot_data);
            $(".gallery-thumbs").html(img_thumbs_html);

            var galleryTop = new Swiper('.gallery-top', {
                spaceBetween: 5,
                loop: true,
                allowTouchMove: false,

                loopedSlides: img_length, //looped slides should be the same
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                pagination: {
                    el: '.swiper-pagination',
                    type: 'fraction',
                },
            });

            var galleryThumbs = new Swiper('.gallery-thumbs', {
                spaceBetween: 9,
                slidesPerView: img_length >= 8 ? 8 : img_length,
                touchRatio: 0.2,
                loop: true,
                centeredSlides: false,
                allowTouchMove: false,
                loopedSlides: img_length, //looped slides should be the same
                slideToClickedSlide: true,
            });

            galleryTop.controller.control = galleryThumbs;
            galleryThumbs.controller.control = galleryTop;
        },
        //详情相册
        popup_img: function (spot_data) {
            //图片
            var img_length = spot_data.image_url.length;
            var popup_img_tem = '{{each image_url as value i}}\
                                {{if i <= 4}}\
                                <li><img src={{value}} alt=""></li>\
                                {{/if}}\
                                {{/each}}';
            var popup_img_render = template.compile(popup_img_tem);
            var popup_img_html = popup_img_render(spot_data);
            $(".popup_img_url").html(popup_img_html);
            if (img_length >= 5) {
                $(".last_li_img").show();
            } else {
                $(".last_li_img").hide();
            };
        }
    } 
    // 景点详情 end

})
